<div class="p-6 pt-12 pb-32 flex flex-col min-h-screen">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
        <a href="/vet" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        <div class="flex-1">
            <h1 class="text-xl font-bold">AI ìˆ˜ì˜ì‚¬ ìƒë‹´</h1>
            <p class="text-xs text-gray-400" id="usageCounter">ì˜¤ëŠ˜ ë‚¨ì€ ì§ˆë¬¸: 20/20</p>
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div class="flex-1 space-y-4 overflow-y-auto hide-scrollbar mb-4" id="chatMessages">
        <!-- AI Welcome Message -->
        <div class="flex gap-3">
            <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                    </path>
                </svg>
            </div>
            <div class="glass p-4 rounded-2xl rounded-tl-none max-w-[80%]">
                <p class="text-sm">ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” AI ìˆ˜ì˜ì‚¬ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ğŸ¾</p>
                <p class="text-sm mt-2 text-gray-300">ë°˜ë ¤ë™ë¬¼ì˜ ê±´ê°•ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. ì†Œë³€ ê²€ì‚¬ ê²°ê³¼ í•´ì„, ì¼ë°˜ì ì¸ ê±´ê°• ì •ë³´, ì¦ìƒì—
                    ëŒ€í•œ ì¡°ì–¸ ë“±ì„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p class="text-xs text-gray-400 mt-2">* ì´ ì„œë¹„ìŠ¤ëŠ” ì°¸ê³ ìš©ì´ë©°, ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ì„œëŠ” ë°˜ë“œì‹œ ìˆ˜ì˜ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <!-- Sample Question Chips -->
        <div class="flex flex-wrap gap-2 px-2">
            <button
                class="question-chip px-3 py-2 bg-white/10 rounded-full text-xs hover:bg-white/20 transition-colors">
                ì†Œë³€ì—ì„œ í”¼ê°€ ë³´ì—¬ìš”
            </button>
            <button
                class="question-chip px-3 py-2 bg-white/10 rounded-full text-xs hover:bg-white/20 transition-colors">
                pH ìˆ˜ì¹˜ê°€ ë†’ìœ¼ë©´?
            </button>
            <button
                class="question-chip px-3 py-2 bg-white/10 rounded-full text-xs hover:bg-white/20 transition-colors">
                ë‹¨ë°±ë‡¨ê°€ ë­”ê°€ìš”?
            </button>
            <button
                class="question-chip px-3 py-2 bg-white/10 rounded-full text-xs hover:bg-white/20 transition-colors">
                ë¬¼ì„ ë„ˆë¬´ ë§ì´ ë§ˆì…”ìš”
            </button>
        </div>
    </div>

    <!-- Input Area -->
    <div class="glass p-4 rounded-2xl flex gap-3 items-center">
        <input type="text" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
            class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-400">
        <button id="sendBtn"
            class="w-10 h-10 bg-primary rounded-full flex items-center justify-center hover:bg-primary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
        </button>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const questionChips = document.querySelectorAll('.question-chip');

    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex gap-3 ' + (isUser ? 'justify-end' : '');

        if (isUser) {
            messageDiv.innerHTML = `
                <div class="bg-primary p-4 rounded-2xl rounded-tr-none max-w-[80%]">
                    <p class="text-sm">${escapeHtml(text)}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="glass p-4 rounded-2xl rounded-tl-none max-w-[80%]">
                    <p class="text-sm whitespace-pre-line text-gray-100">${escapeHtml(text)}</p>
                </div>
            `;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLoadingMessage() {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex gap-3';
        loadingDiv.id = 'loadingMessage';
        loadingDiv.innerHTML = `
            <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-primary animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <div class="glass p-4 rounded-2xl rounded-tl-none">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeLoadingMessage() {
        const loadingMsg = document.getElementById('loadingMessage');
        if (loadingMsg) loadingMsg.remove();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function handleQuestion(question) {
        if (!question.trim()) return;

        chatInput.disabled = true;
        sendBtn.disabled = true;

        addMessage(question, true);
        addLoadingMessage();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: question })
            });

            const data = await response.json();

            removeLoadingMessage();

            if (response.ok) {
                addMessage(data.reply, false);

                // Update usage counter
                if (data.remaining !== undefined) {
                    const counter = document.getElementById('usageCounter');
                    if (counter) {
                        counter.textContent = `ì˜¤ëŠ˜ ë‚¨ì€ ì§ˆë¬¸: ${data.remaining}/20`;
                        if (data.remaining === 0) {
                            counter.classList.add('text-red-400');
                        }
                    }
                }
            } else {
                addMessage(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
            }
        } catch (error) {
            console.error('Chat error:', error);
            removeLoadingMessage();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', false);
        } finally {
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    questionChips.forEach(chip => {
        chip.addEventListener('click', () => {
            handleQuestion(chip.textContent.trim());
        });
    });

    sendBtn.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (text) {
            handleQuestion(text);
            chatInput.value = '';
        }
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const text = chatInput.value.trim();
            if (text) {
                handleQuestion(text);
                chatInput.value = '';
            }
        }
    });
</script>