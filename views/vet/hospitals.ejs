<div class="flex flex-col h-screen" data-turbo="false">
    <!-- Header -->
    <div class="p-6 pb-4 flex items-center gap-4">
        <a href="/vet" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        <div class="flex-1">
            <h1 class="text-xl font-bold">ì£¼ë³€ ë³‘ì› ì°¾ê¸°</h1>
            <p class="text-xs text-gray-400" id="statusText">ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- Map Container - Fixed height for better list visibility -->
    <div id="map" class="relative" style="height: 35vh; min-height: 200px;">
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-background/80 z-10">
            <div class="text-center">
                <div
                    class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-3">
                </div>
                <p class="text-sm text-gray-300">ì£¼ë³€ ë³‘ì›ì„ ì°¾ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- Hospital List Bottom Sheet - Expandable -->
    <div id="hospitalSheet" class="glass p-4 pb-32 rounded-t-3xl flex-1 overflow-y-auto hide-scrollbar">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <svg class="w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zm-6 14H5v-5h8v5zm6 0h-4v-5h4v5zm0-7H5V5h14v5z" />
                </svg>
                ë™ë¬¼ë³‘ì› <span id="hospitalCount" class="text-primary">0</span>ê³³
            </h2>
        </div>

        <div id="hospitalList" class="space-y-3">
            <!-- Hospitals will be inserted here -->
        </div>

        <div id="noResults" class="hidden text-center py-8">
            <svg class="w-16 h-16 text-gray-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-gray-400">ì£¼ë³€ 5km ì´ë‚´ì— ë™ë¬¼ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-xs text-gray-500 mt-2">ë‹¤ë¥¸ ìœ„ì¹˜ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
        </div>
    </div>
</div>

<script>
    let map;
    let markers = [];
    let userLocation = null;
    let kakaoLoaded = false;

    // Dynamically load Kakao Maps SDK
    function loadKakaoSDK() {
        return new Promise((resolve, reject) => {
            if (typeof kakao !== 'undefined' && kakao.maps) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=<%= kakaoApiKey %>&libraries=services&autoload=false';
            script.async = true;
            script.onload = () => {
                kakao.maps.load(() => {
                    kakaoLoaded = true;
                    resolve();
                });
            };
            script.onerror = () => {
                reject(new Error('Kakao Maps SDK ë¡œë”© ì‹¤íŒ¨'));
            };
            document.head.appendChild(script);
        });
    }

    // Initialize
    async function init() {
        try {
            await loadKakaoSDK();
            getUserLocation();
        } catch (error) {
            showError('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Start initialization
    init();

    function getUserLocation() {
        if (!navigator.geolocation) {
            showError('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                initMap();
                searchNearbyHospitals();
            },
            (error) => {
                console.error('Geolocation error:', error);
                // Default to Seoul City Hall if location denied
                userLocation = { lat: 37.5665, lng: 126.9780 };
                showError('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„œìš¸ì‹œì²­ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.');
                initMap();
                searchNearbyHospitals();
            }
        );
    }

    function initMap() {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
            level: 5 // Zoom level (5km radius view)
        };

        map = new kakao.maps.Map(container, options);

        // Add user location marker
        const userMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
            image: new kakao.maps.MarkerImage(
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTIiIGZpbGw9IiMwMTc1QzIiIGZpbGwtb3BhY2l0eT0iMC4zIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjYiIGZpbGw9IiMwMTc1QzIiLz4KPC9zdmc+',
                new kakao.maps.Size(32, 32),
                { offset: new kakao.maps.Point(16, 16) }
            )
        });

        // Add circle to show 5km radius
        const circle = new kakao.maps.Circle({
            center: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
            radius: 5000, // 5km in meters
            strokeWeight: 2,
            strokeColor: '#0175C2',
            strokeOpacity: 0.5,
            strokeStyle: 'dashed',
            fillColor: '#0175C2',
            fillOpacity: 0.1
        });
        circle.setMap(map);

        updateStatus('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    }

    function searchNearbyHospitals() {
        const places = new kakao.maps.services.Places();

        // Search for animal hospitals (category code: AT4)
        places.categorySearch('AT4', (result, status) => {
            document.getElementById('loading').style.display = 'none';

            if (status === kakao.maps.services.Status.OK) {
                displayHospitals(result);
                updateStatus(`${result.length}ê°œ ë³‘ì› ê²€ìƒ‰ ì™„ë£Œ`);
            } else {
                showNoResults();
                updateStatus('ì£¼ë³€ì— ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤');
            }
        }, {
            location: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
            radius: 5000, // 5km
            sort: kakao.maps.services.SortBy.DISTANCE
        });
    }

    function displayHospitals(hospitals) {
        const listEl = document.getElementById('hospitalList');
        const countEl = document.getElementById('hospitalCount');

        if (hospitals.length === 0) {
            showNoResults();
            return;
        }

        listEl.innerHTML = '';
        countEl.textContent = hospitals.length;

        hospitals.forEach((hospital, index) => {
            // Add marker to map
            addHospitalMarker(hospital, index);

            // Add to list
            const card = createHospitalCard(hospital);
            listEl.appendChild(card);
        });
    }

    function addHospitalMarker(hospital, index) {
        const position = new kakao.maps.LatLng(hospital.y, hospital.x);

        const marker = new kakao.maps.Marker({
            map: map,
            position: position,
            title: hospital.place_name
        });

        // Click marker to show info
        kakao.maps.event.addListener(marker, 'click', () => {
            map.setCenter(position);
            map.setLevel(3); // Zoom in

            // Scroll to card
            const card = document.getElementById(`hospital-${index}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                card.classList.add('ring-2', 'ring-primary');
                setTimeout(() => card.classList.remove('ring-2', 'ring-primary'), 2000);
            }
        });

        markers.push(marker);
    }

    function createHospitalCard(hospital) {
        const card = document.createElement('div');
        card.id = `hospital-${markers.length - 1}`;
        card.className = 'glass p-4 rounded-xl hover:bg-white/5 transition-all';

        const distance = hospital.distance ? `${(hospital.distance / 1000).toFixed(1)}km` : '-';
        const phone = hospital.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ';
        const address = hospital.road_address_name || hospital.address_name;

        card.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zm-6 14H5v-5h8v5zm6 0h-4v-5h4v5zm0-7H5V5h14v5z"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-white mb-1">${hospital.place_name}</h3>
                    <p class="text-xs text-gray-400 mb-1">
                        ğŸ“ ${distance} Â· ${address}
                    </p>
                    ${phone !== 'ì „í™”ë²ˆí˜¸ ì—†ìŒ' ? `<p class="text-xs text-gray-400">ğŸ“ ${phone}</p>` : ''}
                </div>
            </div>
            <div class="flex gap-2 mt-3">
                ${phone !== 'ì „í™”ë²ˆí˜¸ ì—†ìŒ' ? `
                    <a href="tel:${phone}" 
                       class="flex-1 bg-primary/20 text-primary py-2 px-3 rounded-lg text-sm font-medium text-center hover:bg-primary/30 transition-colors">
                        ğŸ“ ì „í™”í•˜ê¸°
                    </a>
                ` : ''}
                <a href="https://map.kakao.com/link/to/${hospital.place_name},${hospital.y},${hospital.x}" 
                   target="_blank"
                   class="flex-1 bg-white/10 text-white py-2 px-3 rounded-lg text-sm font-medium text-center hover:bg-white/20 transition-colors">
                    ğŸš— ê¸¸ì°¾ê¸°
                </a>
            </div>
        `;

        return card;
    }

    function showNoResults() {
        document.getElementById('hospitalList').innerHTML = '';
        document.getElementById('noResults').classList.remove('hidden');
        document.getElementById('hospitalCount').textContent = '0';
    }

    function updateStatus(text) {
        document.getElementById('statusText').textContent = text;
    }

    function showError(message) {
        updateStatus(message);
        console.error(message);
    }
</script>

<style>
    #map {
        width: 100%;
        /* GPU acceleration for smoother touch interactions */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform;
    }

    /* Optimize touch scrolling for hospital list */
    #hospitalSheet {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }

    /* Prevent body scroll when interacting with map */
    #map * {
        touch-action: pan-x pan-y;
    }
</style>